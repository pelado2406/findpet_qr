<form onsubmit="event.preventDefault(); generarFichaYSubir();" style="max-width:400px;margin:auto;">
  <h2>Registrar Mascota</h2>
  <label for="nombre">ğŸ¶ Nombre:</label>
  <input type="text" id="nombre" required><br><br>

  <label for="telefono">ğŸ“ TelÃ©fono:</label>
  <input type="tel" id="telefono" required><br><br>

  <label for="whatsapp">ğŸ’¬ WhatsApp (sin +):</label>
  <input type="tel" id="whatsapp" required><br><br>

  <label for="direccion">ğŸ“ DirecciÃ³n:</label>
  <input type="text" id="direccion" required><br><br>

  <button type="submit">âœ… Crear Ficha</button>
</form>

<div id="qrContainer" style="text-align:center; margin-top:20px; display:none;">
  <h3>ğŸ“Œ CÃ³digo QR de la ficha</h3>
  <canvas id="qrCanvas"></canvas><br>
  <button onclick="descargarQR()">â¬‡ï¸ Descargar QR</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
function obtenerCodigoDesdeURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get('code');
}

async function verificarCodigoDisponible(codigo) {
  const url = `https://raw.githubusercontent.com/pelado2406/findpet_qr/main/fichas/${codigo}.html`;
  const resp = await fetch(url);
  return !resp.ok;
}

async function subirFichaAGithub(nombreArchivo, contenidoHTML, urlFinal) {
  const token = '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';
  const usuario = 'pelado2406';
  const repositorio = 'findpet_qr';
  const rutaArchivo = `fichas/${nombreArchivo}`;
  const apiUrl = `https://api.github.com/repos/${usuario}/${repositorio}/contents/${rutaArchivo}`;

  const contenidoCodificado = btoa(unescape(encodeURIComponent(contenidoHTML)));

  const body = {
    message: `Subir ficha ${nombreArchivo}`,
    content: contenidoCodificado
  };

  const respuesta = await fetch(apiUrl, {
    method: 'PUT',
    headers: {
      'Authorization': `token ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });

  const datos = await respuesta.json();
  if (respuesta.ok) {
    console.log(`âœ… Ficha subida: ${datos.content.path}`);
    generarQR(urlFinal);
    alert('Ficha subida correctamente.');

    setTimeout(() => {
      window.location.href = urlFinal;
    }, 2000);

  } else {
    console.error('âŒ Error al subir la ficha:', datos);
    alert('Error al subir la ficha.');
  }
}

async function generarFichaYSubir() {
  const codigo = obtenerCodigoDesdeURL();
  if (!codigo) {
    alert('CÃ³digo invÃ¡lido o faltante en el link.');
    return;
  }

  const disponible = await verificarCodigoDisponible(codigo);
  if (!disponible) {
    alert('Este cÃ³digo ya fue usado.');
    return;
  }

  const nombre = document.getElementById('nombre').value.trim();
  const telefono = document.getElementById('telefono').value.trim();
  const whatsapp = document.getElementById('whatsapp').value.trim();
  const direccion = document.getElementById('direccion').value.trim();

  if (!nombre || !telefono || !whatsapp || !direccion) {
    alert('CompletÃ¡ todos los campos.');
    return;
  }

  const nombreArchivo = `${codigo}.html`;
  const contenidoHTML = `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¾ Mascota encontrada</title>
</head>
<body>
  <h1>Â¡Encontraste a ${nombre}!</h1>
  <p>ğŸ“ TelÃ©fono: <a href="tel:${telefono}">${telefono}</a></p>
  <p>ğŸ’¬ WhatsApp: <a href="https://wa.me/${whatsapp}">Mandar mensaje</a></p>
  <p>ğŸ“ DirecciÃ³n: ${direccion}</p>
</body>
</html>`;

  const urlFicha = `https://findpetqr.netlify.app/fichas/${nombreArchivo}`;
  subirFichaAGithub(nombreArchivo, contenidoHTML, urlFicha);
}

function generarQR(url) {
  const qrContainer = document.getElementById('qrContainer');
  const canvas = document.getElementById('qrCanvas');
  qrContainer.style.display = 'block';
  QRCode.toCanvas(canvas, url, { width: 200 }, function (error) {
    if (error) console.error(error);
    console.log('QR generado');
  });
}

function descargarQR() {
  const canvas = document.getElementById('qrCanvas');
  const link = document.createElement('a');
  link.download = 'qr_mascota.png';
  link.href = canvas.toDataURL();
  link.click();
}
</script>

<!-- Sistema de generaciÃ³n de link personalizado con cÃ³digo -->
<div style="text-align:center; margin-top:40px;">
  <h2>ğŸ”— Crear Link para Cliente</h2>
  <input type="text" id="nuevoCodigo" placeholder="Ej: fido123" style="width:200px;"> 
  <button onclick="generarLinkCliente()">ğŸ¯ Generar Link</button>
  <p id="linkGenerado"></p>
</div>

<script>
function generarLinkCliente() {
  const codigo = document.getElementById('nuevoCodigo').value.trim();
  if (!codigo) {
    alert('EscribÃ­ un cÃ³digo.');
    return;
  }
  const link = `https://findpetqr.netlify.app/registro.html?code=${codigo}`;
  const p = document.getElementById('linkGenerado');
  p.innerHTML = `Link: <a href="${link}" target="_blank">${link}</a>`;
}
</script>


